<!DOCTYPE HTML><html><head><title>dbo.dba_indexDefrag_sp</title><link rel="stylesheet" href="../../../../../Style/Master.css" type="text/css"><script src="../../../../../Scripts/jquery-1.9.1.js" type="text/javascript"></script><script src="../../../../../Scripts/sections.js" type="text/javascript"></script></head><body><div id="wrap"><div id="container"><div id="header"><div id="breadcrumbs"><a href="../../../../../index.html">Project</a> &gt; <a href="../../../../../RaMP/index.html">RaMP</a> &gt; <a href="../../../../../RaMP/User_databases/index.html">User databases</a> &gt; <a href="../../../../../RaMP/User_databases/2.6.1/index.html">2.6.1</a> &gt; Programmability &gt; <a href="../../../../../RaMP/User_databases/2.6.1/Programmability/Stored_Procedures/Stored_Procedures.html">Stored Procedures</a> &gt; dbo.dba_indexDefrag_sp</div><div id="headerText"></div></div><div id="pageTitle"><img src="../../../../../Images/StoredProcedure32.png" alt="Stored Procedures" title="Stored Procedures" class="StoredProcedure32"> [dbo].[dba_indexDefrag_sp]</div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="properties">Properties</a></div><div class="panel-body"><table cellspacing="1" border="0" class="dataTable table-hover"><tbody><tr><th>Property</th><th>Value</th></tr><tr><td>ANSI Nulls On</td><td><span class="do-yes">True</span></td></tr><tr><td>Quoted Identifier On</td><td><span class="do-yes">True</span></td></tr></tbody></table></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="parameters">Parameters</a></div><div class="panel-body"><table cellspacing="1" border="0" class="dataTable table-hover"><tbody><tr><th>Name</th><th>Data Type</th><th>Max Length (Bytes)</th></tr><tr><td>@minFragmentation</td><td>float</td><td>8</td></tr><tr><td>@rebuildThreshold</td><td>float</td><td>8</td></tr><tr><td>@executeSQL</td><td>bit</td><td>1</td></tr><tr><td>@defragOrderColumn</td><td>nvarchar(20)</td><td>40</td></tr><tr><td>@defragSortOrder</td><td>nvarchar(4)</td><td>8</td></tr><tr><td>@timeLimit</td><td>int</td><td>4</td></tr><tr><td>@database</td><td>varchar(128)</td><td>128</td></tr><tr><td>@tableName</td><td>varchar(4000)</td><td>4000</td></tr><tr><td>@forceRescan</td><td>bit</td><td>1</td></tr><tr><td>@scanMode</td><td>varchar(10)</td><td>10</td></tr><tr><td>@minPageCount</td><td>int</td><td>4</td></tr><tr><td>@maxPageCount</td><td>int</td><td>4</td></tr><tr><td>@excludeMaxPartition</td><td>bit</td><td>1</td></tr><tr><td>@onlineRebuild</td><td>bit</td><td>1</td></tr><tr><td>@sortInTempDB</td><td>bit</td><td>1</td></tr><tr><td>@maxDopRestriction</td><td>tinyint</td><td>1</td></tr><tr><td>@printCommands</td><td>bit</td><td>1</td></tr><tr><td>@printFragmentation</td><td>bit</td><td>1</td></tr><tr><td>@defragDelay</td><td>char(8)</td><td>8</td></tr><tr><td>@debugMode</td><td>bit</td><td>1</td></tr></tbody></table></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="sqlscript">SQL Script</a></div><div class="panel-body"><div id="sqlScript"><br><span class="sqlScriptsKeyword">Create</span> <span class="sqlScriptsKeyword">Procedure</span> <span class="sqlScriptsNormal">dbo.dba_indexDefrag_sp</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Declare Parameters */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">@minFragmentation</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">float</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">10.0</span> &nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* in percent, will not defrag if fragmentation less than specified */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">float</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">30.0</span> &nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* in percent, greater than @rebuildThreshold will result in rebuild instead of reorg */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@executeSQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = execute; 0 = print command only */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@defragOrderColumn</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">20</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;range_scan_count&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Valid options are: range_scan_count, fragmentation, page_count */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@defragSortOrder</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;DESC&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Valid options are: ASC, DESC */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@timeLimit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">720</span> <span class="sqlScriptsComment">/* defaulted to 12 hours */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Optional time limitation; expressed in minutes */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@database</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Option to specify a database name; null will return all */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@tableName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsOperator">Null</span> &nbsp;<span class="sqlScriptsComment">-- databaseName.schema.tableName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Option to specify a table name; null will return all */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@forceRescan</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Whether or not to force a rescan of indexes; 1 = force, 0 = use existing scan, if available */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@scanMode</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;LIMITED&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Options are LIMITED, SAMPLED, and DETAILED */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@minPageCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">8</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* &nbsp;MS recommends &gt; 1 extent (8 pages) */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@maxPageCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* NULL = no limit */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@excludeMaxPartition</span> &nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = exclude right-most populated partition; 0 = do not exclude; see notes for caveats */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@onlineRebuild</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = online rebuild; 0 = offline rebuild; only in Enterprise */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@sortInTempDB</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = perform sort operation in TempDB; 0 = perform sort operation in the index&#39;s database */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">tinyint</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Option to restrict the number of processors for the operation; only in Enterprise */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@printCommands</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> &nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = print commands; 0 = do not print commands */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@printFragmentation</span> &nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* 1 = print fragmentation prior to defrag; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = do not print */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@defragDelay</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">char</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">8</span><span class="sqlScriptsOperator">)</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;00:00:05&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* time to wait between defrag commands */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@debugMode</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* display some useful comments to help determine if/where issues occur */</span><br><br><span class="sqlScriptsKeyword">As</span><br><span class="sqlScriptsComment">/*********************************************************************************<br> &nbsp;&nbsp;&nbsp;Name: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dba_indexDefrag_sp<br><br> &nbsp;&nbsp;&nbsp;Author: &nbsp;&nbsp;&nbsp;&nbsp;Michelle Ufford, http://sqlfool.com<br><br> &nbsp;&nbsp;&nbsp;Purpose: &nbsp;&nbsp;&nbsp;Defrags one or more indexes for one or more databases<br><br> &nbsp;&nbsp;&nbsp;Notes:<br><br> &nbsp;&nbsp;&nbsp;CAUTION: TRANSACTION LOG SIZE SHOULD BE MONITORED CLOSELY WHEN DEFRAGMENTING.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DO NOT RUN UNATTENDED ON LARGE DATABASES DURING BUSINESS HOURS.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@minFragmentation &nbsp;&nbsp;&nbsp;&nbsp;defaulted to 10%, will not defrag if fragmentation <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is less than that<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@rebuildThreshold &nbsp;&nbsp;&nbsp;&nbsp;defaulted to 30% as recommended by Microsoft in BOL;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;greater than 30% will result in rebuild instead<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@executeSQL &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = execute the SQL generated by this proc; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = print command only<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@defragOrderColumn &nbsp;&nbsp;&nbsp;Defines how to prioritize the order of defrags. &nbsp;Only<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;used if @executeSQL = 1. &nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Valid options are: <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;range_scan_count = count of range and table scans on the<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index; in general, this is what benefits <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the most from defragmentation<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragmentation &nbsp;&nbsp;&nbsp;= amount of fragmentation in the index;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the higher the number, the worse it is<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;page_count &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= number of pages in the index; affects<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;how long it takes to defrag an index<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@defragSortOrder &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The sort order of the ORDER BY clause.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Valid options are ASC (ascending) or DESC (descending).<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@timeLimit &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional, limits how much time can be spent performing <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index defrags; expressed in minutes.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOTE: The time limit is checked BEFORE an index defrag<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is begun, thus a long index defrag can exceed the<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time limitation.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@database &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Optional, specify specific database name to defrag;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;If not specified, all non-system databases will<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;be defragged.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@tableName &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specify if you only want to defrag indexes for a <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;specific table, format = databaseName.schema.tableName;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if not specified, all tables will be defragged.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@forceRescan &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Whether or not to force a rescan of indexes. &nbsp;If set<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to 0, a rescan will not occur until all indexes have<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;been defragged. &nbsp;This can span multiple executions.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = force a rescan<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = use previous scan, if there are indexes left to defrag<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@scanMode &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies which scan mode to use to determine<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fragmentation levels. &nbsp;Options are:<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LIMITED - scans the parent level; quickest mode,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recommended for most cases.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SAMPLED - samples 1% of all data pages; if less than<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10k pages, performs a DETAILED scan.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DETAILED - scans all data pages. &nbsp;Use great care with<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this mode, as it can cause performance issues.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@minPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies how many pages must exist in an index in order <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to be considered for a defrag. &nbsp;Defaulted to 8 pages, as <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Microsoft recommends only defragging indexes with more <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;than 1 extent (8 pages). &nbsp;<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOTE: The @minPageCount will restrict the indexes that<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;are stored in dba_indexDefragStatus table.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@maxPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies the maximum number of pages that can exist in <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;an index and still be considered for a defrag. &nbsp;Useful<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for scheduling small indexes during business hours and<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large indexes for non-business hours.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOTE: The @maxPageCount will restrict the indexes that<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;are defragged during the current operation; it will not<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;prevent indexes from being stored in the <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dba_indexDefragStatus table. &nbsp;This way, a single scan<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;can support multiple page count thresholds.<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@excludeMaxPartition &nbsp;If an index is partitioned, this option specifies whether<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to exclude the right-most populated partition. &nbsp;Typically,<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this is the partition that is currently being written to in<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a sliding-window scenario. &nbsp;Enabling this feature may reduce<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contention. &nbsp;This may not be applicable in other types of <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;partitioning scenarios. &nbsp;Non-partitioned indexes are <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unaffected by this option.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = exclude right-most populated partition<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = do not exclude<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@onlineRebuild &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = online rebuild; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = offline rebuild<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@sortInTempDB &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specifies whether to defrag the index in TEMPDB or in the<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;database the index belongs to. &nbsp;Enabling this option may<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result in faster defrags and prevent database file size <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inflation.<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = perform sort operation in TempDB<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = perform sort operation in the index&#39;s database <br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@maxDopRestriction &nbsp;&nbsp;&nbsp;Option to specify a processor limit for index rebuilds<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@printCommands &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = print commands to screen; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = do not print commands<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@printFragmentation &nbsp;&nbsp;1 = print fragmentation to screen;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = do not print fragmentation<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@defragDelay &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Time to wait between defrag commands; gives the<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;server a little time to catch up <br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@debugMode &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 = display debug comments; helps with troubleshooting<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0 = do not display debug comments<br><br> &nbsp;&nbsp;&nbsp;Called by: &nbsp;SQL Agent Job or DBA<br><br> &nbsp;&nbsp;&nbsp;----------------------------------------------------------------------------<br> &nbsp;&nbsp;&nbsp;DISCLAIMER: <br> &nbsp;&nbsp;&nbsp;This code and information are provided &quot;AS IS&quot; without warranty of any kind,<br> &nbsp;&nbsp;&nbsp;either expressed or implied, including but not limited to the implied <br> &nbsp;&nbsp;&nbsp;warranties or merchantability and/or fitness for a particular purpose.<br> &nbsp;&nbsp;&nbsp;----------------------------------------------------------------------------<br> &nbsp;&nbsp;&nbsp;LICENSE: <br> &nbsp;&nbsp;&nbsp;This index defrag script is free to download and use for personal, educational, <br> &nbsp;&nbsp;&nbsp;and internal corporate purposes, provided that this header is preserved. <br> &nbsp;&nbsp;&nbsp;Redistribution or sale of this index defrag script, in whole or in part, is <br> &nbsp;&nbsp;&nbsp;prohibited without the author&#39;s express written consent.<br> &nbsp;&nbsp;&nbsp;----------------------------------------------------------------------------<br> &nbsp;&nbsp;&nbsp;Date &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Initials &nbsp;&nbsp;&nbsp;Version Description<br> &nbsp;&nbsp;&nbsp;----------------------------------------------------------------------------<br> &nbsp;&nbsp;&nbsp;2007-12-18 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.0 &nbsp;&nbsp;&nbsp;&nbsp;Initial Release<br> &nbsp;&nbsp;&nbsp;2008-10-17 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.1 &nbsp;&nbsp;&nbsp;&nbsp;Added @defragDelay, CIX_temp_indexDefragList<br> &nbsp;&nbsp;&nbsp;2008-11-17 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1.2 &nbsp;&nbsp;&nbsp;&nbsp;Added page_count to log table<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added @printFragmentation option<br> &nbsp;&nbsp;&nbsp;2009-03-17 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2.0 &nbsp;&nbsp;&nbsp;&nbsp;Provided support for centralized execution<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, consolidated Enterprise &amp; Standard versions<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added @debugMode, @maxDopRestriction<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, modified LOB and partition logic &nbsp;<br> &nbsp;&nbsp;&nbsp;2009-06-18 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.0 &nbsp;&nbsp;&nbsp;&nbsp;Fixed bug in LOB logic, added @scanMode option<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added support for stat rebuilds (@rebuildStats)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, support model and msdb defrag<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added columns to the dba_indexDefragLog table<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, modified logging to show &quot;in progress&quot; defrags<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added defrag exclusion list (scheduling)<br> &nbsp;&nbsp;&nbsp;2009-08-28 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3.1 &nbsp;&nbsp;&nbsp;&nbsp;Fixed read_only bug for database lists<br> &nbsp;&nbsp;&nbsp;2010-04-20 &nbsp;MFU &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4.0 &nbsp;&nbsp;&nbsp;&nbsp;Added time limit option<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added static table with rescan logic<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added parameters for page count &amp; SORT_IN_TEMPDB<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added try/catch logic and additional debug options<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added options for defrag prioritization<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, fixed bug for indexes with allow_page_lock = off<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, added option to exclude right-most partition<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, removed @rebuildStats option<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, refer to http://sqlfool.com for full release notes<br>*********************************************************************************<br> &nbsp;&nbsp;&nbsp;Example of how to call this script:<br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Exec dbo.dba_indexDefrag_sp<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@executeSQL &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @printCommands &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @debugMode &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @printFragmentation &nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @forceRescan &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @maxDopRestriction &nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @minPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= 8<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @maxPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= Null<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @minFragmentation &nbsp;&nbsp;&nbsp;&nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @rebuildThreshold &nbsp;&nbsp;&nbsp;&nbsp;= 30<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @defragDelay &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= &#39;00:00:05&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @defragOrderColumn &nbsp;&nbsp;&nbsp;= &#39;page_count&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @defragSortOrder &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= &#39;DESC&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @excludeMaxPartition &nbsp;= 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @timeLimit &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= Null;<br>*********************************************************************************/</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsKeyword">NoCount</span> <span class="sqlScriptsKeyword">On</span><span class="sqlScriptsNormal">;</span><br><span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsKeyword">XACT_Abort</span> <span class="sqlScriptsKeyword">On</span><span class="sqlScriptsNormal">;</span><br><span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsKeyword">Quoted_Identifier</span> <span class="sqlScriptsKeyword">On</span><span class="sqlScriptsNormal">;</span><br><br><span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span> <span class="sqlScriptsNormal">Try</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Just a little validation... */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@minFragmentation</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@minFragmentation</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Between</span> <span class="sqlScriptsNormal">0.00</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">100.0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@minFragmentation</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">10.0</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Between</span> <span class="sqlScriptsNormal">0.00</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">100.0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">30.0</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@defragDelay</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Like</span> <span class="sqlScriptsString">&#39;00:[0-5][0-9]:[0-5][0-9]&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@defragDelay</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;00:00:05&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@defragOrderColumn</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@defragOrderColumn</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">In</span> <span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;range_scan_count&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;fragmentation&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;page_count&#39;</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@defragOrderColumn</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;range_scan_count&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@defragSortOrder</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@defragSortOrder</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">In</span> <span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;ASC&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;DESC&#39;</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@defragSortOrder</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;DESC&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@scanMode</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">In</span> <span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;LIMITED&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;SAMPLED&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;DETAILED&#39;</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@scanMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;LIMITED&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@forceRescan</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@forceRescan</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@sortInTempDB</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@sortInTempDB</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><span class="sqlScriptsNormal">;</span><br><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;Undusting the cogs and starting up...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Declare our variables */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Declare</span> &nbsp;&nbsp;<span class="sqlScriptsNormal">@objectID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@databaseID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@databaseName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bigint</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@schemaName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@objectName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionNumber</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">smallint</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@fragmentation</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">float</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@pageCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@sqlCommand</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@rebuildCommand</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">200</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@dateTimeStart</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">datetime</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@dateTimeEnd</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">datetime</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@containsLOB</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@editionCheck</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@debugMessage</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@updateSQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionSQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionSQL_Param</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">1000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@LOB_SQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@LOB_SQL_Param</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">1000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexDefrag_id</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@startDateTime</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">datetime</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@endDateTime</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">datetime</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@getIndexSQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@getIndexSQL_Param</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLockSQL</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLockSQL_Param</span> &nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLocks</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@excludeMaxPartitionSQL</span> &nbsp;&nbsp;<span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">4000</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Initialize our variables */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@startDateTime</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">()</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@endDateTime</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">DateAdd</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">minute</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@timeLimit</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">());</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Create our temporary tables */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Create</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">databaseID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">databaseName</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">scanStatus</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">bit</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Create</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">processor</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">[index]</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsKeyword">Name</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">128</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">Internal_Value</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">Character_Value</span> &nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Create</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">maxPartitionList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">databaseID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">maxPartition</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">int</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;Beginning validation...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Make sure we&#39;re not exceeding the number of processors we have available */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Insert</span> <span class="sqlScriptsKeyword">Into</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">processor</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">xp_msver</span> <span class="sqlScriptsString">&#39;ProcessorCount&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">Internal_Value</span> <span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">processor</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">Internal_Value</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">processor</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Check our server version; 1804890536 = Enterprise, 610778273 = Enterprise Evaluation, -2117995310 = Developer */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsFunction">ServerProperty</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;EditionID&#39;</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">In</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">1804890536</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">610778273</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsOperator">-</span><span class="sqlScriptsNormal">2117995310</span><span class="sqlScriptsOperator">)</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsComment">-- supports online rebuilds</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">;</span> <span class="sqlScriptsComment">-- does not support online rebuilds</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Output the parameters we&#39;re working with */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@debugMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;Your selected parameters are... <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defrag indexes with fragmentation greater than &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@minFragmentation</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rebuild indexes with fragmentation greater than &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@executeSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; DO&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; DO NOT&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; want the commands to be executed automatically; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You want to defrag indexes in &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@defragSortOrder</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; order of the &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">UPPER</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@defragOrderColumn</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; value;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You have&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@timeLimit</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; not specified a time limit;&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; specified a time limit of &#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@timeLimit</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; minutes;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@database</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39;ALL databases&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39;The &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@database</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; database&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; will be defragged;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@tableName</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39;ALL tables&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39;The &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@tableName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; table&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; will be defragged;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;We&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsOperator">Exists</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsKeyword">Top</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">*</span> <span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span> <span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@forceRescan</span> <span class="sqlScriptsNormal">&lt;&gt;</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; WILL NOT&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; WILL&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; be rescanning indexes;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The scan will be performed in &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@scanMode</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; mode;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You want to limit defrags to indexes with&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@maxPageCount</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; more than &#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@minPageCount</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsString">&#39; between &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@minPageCount</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; and &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@maxPageCount</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; pages;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indexes will be defragged&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@onlineRebuild</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; OFFLINE;&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; ONLINE;&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Indexes will be sorted in&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@sortInTempDB</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; the DATABASE&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; TEMPDB;&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Defrag operations will utilize &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39;system defaults for processors;&#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">2</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; processors;&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@printCommands</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; DO&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; DO NOT&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; want to print the ALTER INDEX commands; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@printFragmentation</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; DO&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; DO NOT&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; want to output fragmentation levels; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You want to wait &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@defragDelay</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; (hh:mm:ss) between defragging indexes;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You want to run in&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39; DEBUG&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39; SILENT&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; mode.&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@debugMessage</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;Grabbing a list of our databases...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Retrieve the list of databases to investigate */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Insert</span> <span class="sqlScriptsKeyword">Into</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">database_id</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsKeyword">name</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsComment">-- not scanned yet for fragmentation</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsSystemView">sys.databases</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsKeyword">name</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@database</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsKeyword">name</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">[name]</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">In</span> <span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;master&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;tempdb&#39;</span><span class="sqlScriptsNormal">)</span><span class="sqlScriptsComment">-- exclude system databases</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">[state]</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsComment">-- state must be ONLINE</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">is_read_only</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">;</span> &nbsp;<span class="sqlScriptsComment">-- cannot be read_only</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Check to see if we have indexes in need of defrag; otherwise, re-scan the database(s) */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Exists</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsKeyword">Top</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">*</span> <span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span> <span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@forceRescan</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Truncate our list of indexes to prepare for a new scan */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Truncate</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;Looping through our list of databases and checking for fragmentation...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Loop through our list of databases */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">While</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsFunction">Count</span><span class="sqlScriptsNormal">(*)</span> <span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span> <span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">scanStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsKeyword">Top</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsNormal">@databaseID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">scanStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@debugMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39; &nbsp;working on &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">DB_Name</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;...&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@debugMessage</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Determine which indexes to defrag using our user-defined parameters */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Insert</span> <span class="sqlScriptsKeyword">Into</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">databaseName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">partitionNumber</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">fragmentation</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">page_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">range_scan_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">scanDate</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">ps.database_id</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;databaseID&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">QuoteName</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">DB_Name</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ps.database_id</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;databaseName&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.object_id</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;objectID&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.index_id</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;indexID&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.partition_number</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;partitionNumber&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">Sum</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ps.avg_fragmentation_in_percent</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;fragmentation&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">Sum</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ps.page_count</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;page_count&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">os.range_scan_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">()</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsString">&#39;scanDate&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">sys.dm_db_index_physical_stats</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">Object_Id</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@tableName</span><span class="sqlScriptsNormal">),</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsNormal">,</span> <span class="sqlScriptsOperator">Null</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@scanMode</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsNormal">ps</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Join</span> <span class="sqlScriptsNormal">sys.dm_db_index_operational_stats</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">Object_Id</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@tableName</span><span class="sqlScriptsNormal">),</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsNormal">,</span> <span class="sqlScriptsOperator">Null</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">as</span> <span class="sqlScriptsNormal">os</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">On</span> <span class="sqlScriptsNormal">ps.database_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">os.database_id</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ps.object_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">os.object_id</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">and</span> <span class="sqlScriptsNormal">ps.index_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">os.index_id</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ps.partition_number</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">os.partition_number</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">avg_fragmentation_in_percent</span> <span class="sqlScriptsNormal">&gt;=</span> <span class="sqlScriptsNormal">@minFragmentation</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ps.index_id</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsComment">-- ignore heaps</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ps.page_count</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">@minPageCount</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ps.index_level</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsComment">-- leaf-level nodes only, supports @scanMode</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Group</span> <span class="sqlScriptsKeyword">By</span> <span class="sqlScriptsNormal">ps.database_id</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">QuoteName</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">DB_Name</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">ps.database_id</span><span class="sqlScriptsNormal">))</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.object_id</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.index_id</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">ps.partition_number</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">os.range_scan_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Option</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">MaxDop</span> <span class="sqlScriptsNormal">2</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Do we want to exclude right-most populated partition of our partitioned indexes? */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@excludeMaxPartition</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@excludeMaxPartitionSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; As [databaseID]<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, [object_id]<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, index_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, Max(partition_number) As [maxPartition]<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">DB_Name</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.partitions<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where partition_number &gt; 1<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And [rows] &gt; 0<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Group By object_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, index_id;&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Insert</span> <span class="sqlScriptsKeyword">Into</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">maxPartitionList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@excludeMaxPartitionSQL</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Keep track of which databases have already been scanned */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">scanStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">databaseID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* We don&#39;t want to defrag the right-most populated partition, so<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;delete any records for partitioned indexes where partition = Max(partition) */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@excludeMaxPartition</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Delete</span> <span class="sqlScriptsNormal">ids</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsNormal">ids</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Join</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">maxPartitionList</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsNormal">mpl</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">On</span> <span class="sqlScriptsNormal">ids.databaseID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">mpl.databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ids.objectID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">mpl.objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ids.indexID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">mpl.indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ids.partitionNumber</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">mpl.maxPartition</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Update our exclusion mask for any index that has a restriction on the days it can be defragged */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">ids</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">ids.exclusionMask</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">ide.exclusionMask</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsNormal">ids</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Join</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragExclusion</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsNormal">ide</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">On</span> <span class="sqlScriptsNormal">ids.databaseID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">ide.databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ids.objectID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">ide.objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">ids.indexID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">ide.indexID</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@debugMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;Looping through our list... there are &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">Count</span><span class="sqlScriptsNormal">(*)</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; indexes to defrag!&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">page_count</span> <span class="sqlScriptsOperator">Between</span> <span class="sqlScriptsNormal">@minPageCount</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@maxPageCount</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">page_count</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@debugMessage</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Begin our loop for defragging */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">While</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsFunction">Count</span><span class="sqlScriptsNormal">(*)</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@executeSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span><span class="sqlScriptsOperator">)</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@executeSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">printStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">exclusionMask</span> <span class="sqlScriptsOperator">&amp;</span> <span class="sqlScriptsFunction">Power</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">2</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">DatePart</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">weekday</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">())-</span><span class="sqlScriptsNormal">1</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">page_count</span> <span class="sqlScriptsOperator">Between</span> <span class="sqlScriptsNormal">@minPageCount</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@maxPageCount</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">page_count</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Check to see if we need to exit our loop because of our time limit */</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@endDateTime</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">())</span> <span class="sqlScriptsOperator">&lt;</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">()</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;Our time limit has been exceeded!&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">11</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Picking an index to beat into shape...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Grab the index with the highest priority, based on the values submitted; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Look at the exclusion mask to ensure it can be defragged today */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@getIndexSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Select Top 1 <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@objectID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= objectID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @indexID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= indexID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @databaseID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= databaseID<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @databaseName_Out &nbsp;&nbsp;&nbsp;&nbsp;= databaseName<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @fragmentation_Out &nbsp;&nbsp;&nbsp;= fragmentation<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @partitionNumber_Out &nbsp;= partitionNumber<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @pageCount_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= page_count<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From dbo.dba_indexDefragStatus<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where defragDate Is Null &#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsKeyword">Case</span> <span class="sqlScriptsKeyword">When</span> <span class="sqlScriptsNormal">@executeSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span> <span class="sqlScriptsKeyword">Then</span> <span class="sqlScriptsString">&#39;And printStatus = 0&#39;</span> <span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsString">&#39;&#39;</span> <span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And exclusionMask &amp; Power(2, DatePart(weekday, GetDate())-1) = 0<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And page_count Between @p_minPageCount and IsNull(@p_maxPageCount, page_count)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Order By + &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@defragOrderColumn</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@defragSortOrder</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@getIndexSQL_Param</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;@objectID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @indexID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @databaseID_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @databaseName_Out &nbsp;&nbsp;&nbsp;nvarchar(128) OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @fragmentation_Out &nbsp;&nbsp;int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @partitionNumber_Out int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @pageCount_Out &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int OutPut<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @p_minPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, @p_maxPageCount &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@getIndexSQL</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@getIndexSQL_Param</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@p_minPageCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@minPageCount</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@p_maxPageCount</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@maxPageCount</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@objectID_Out</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@objectID</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexID_Out</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexID</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@databaseID_Out</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseID</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@databaseName_Out</span> &nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@fragmentation_Out</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@fragmentation</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionNumber_Out</span> &nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@partitionNumber</span> <span class="sqlScriptsKeyword">OutPut</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@pageCount_Out</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@pageCount</span> <span class="sqlScriptsKeyword">OutPut</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Looking up the specifics for our index...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Look up index information */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@updateSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;Update ids<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set schemaName = QuoteName(s.name)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, objectName = QuoteName(o.name)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, indexName = QuoteName(i.name)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From dbo.dba_indexDefragStatus As ids<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inner Join &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.objects As o<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On ids.objectID = o.object_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inner Join &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.indexes As i<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On o.object_id = i.object_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And ids.indexID = i.index_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Inner Join &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.schemas As s<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On o.schema_id = s.schema_id<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where o.object_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@objectID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And i.index_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@indexID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And i.type &gt; 0<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And ids.databaseID = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@databaseID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">));</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@updateSQL</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Grab our object names */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@objectName</span> &nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">objectName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@schemaName</span> &nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">schemaName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexName</span> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">indexName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">objectID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">indexID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">databaseID</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseID</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Grabbing the partition count...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Determine if the index is partitioned */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@partitionSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;Select @partitionCount_OUT = Count(*)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.partitions<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where object_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@objectID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And index_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@indexID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;;&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionSQL_Param</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;@partitionCount_OUT int OutPut&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@partitionSQL</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionSQL_Param</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionCount_OUT</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@partitionCount</span> <span class="sqlScriptsKeyword">OutPut</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Seeing if there are any LOBs to be handled...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Determine if the table contains LOBs */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@LOB_SQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39; Select @containsLOB_OUT = Count(*)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.columns With (NoLock) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where [object_id] = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@objectID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And (system_type_id In (34, 35, 99)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Or max_length = -1);&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* &nbsp;system_type_id --&gt; 34 = image, 35 = text, 99 = ntext<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;max_length = -1 --&gt; varbinary(max), varchar(max), nvarchar(max), xml */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@LOB_SQL_Param</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;@containsLOB_OUT int OutPut&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@LOB_SQL</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@LOB_SQL_Param</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@containsLOB_OUT</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@containsLOB</span> <span class="sqlScriptsKeyword">OutPut</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Checking for indexes that do not allow page locks...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Determine if page locks are allowed; for those indexes, we need to always rebuild */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">@allowPageLockSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;Select @allowPageLocks_OUT = Count(*)<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;From &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;.sys.indexes<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Where object_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@objectID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And index_id = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@indexID</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;And Allow_Page_Locks = 0;&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLockSQL_Param</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;@allowPageLocks_OUT int OutPut&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@allowPageLockSQL</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLockSQL_Param</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@allowPageLocks_OUT</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@allowPageLocks</span> <span class="sqlScriptsKeyword">OutPut</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Building our SQL statements...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* If there&#39;s not a lot of fragmentation, or if we have a LOB, we should reorganize */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@fragmentation</span> <span class="sqlScriptsOperator">&lt;</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@containsLOB</span> <span class="sqlScriptsNormal">&gt;=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@partitionCount</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">1</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@allowPageLocks</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">0</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@sqlCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;Alter Index &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@indexName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; On &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;.&#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@schemaName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;.&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@objectName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; ReOrganize&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* If our index is partitioned, we should always reorganize */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@partitionCount</span> <span class="sqlScriptsOperator">&gt;</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@sqlCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@sqlCommand</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; Partition = &#39;</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@partitionNumber</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">nvarchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">));</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* If the index is heavily fragmented and doesn&#39;t contain any partitions or LOB&#39;s, <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or if the index does not allow page locks, rebuild it */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span> <span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@fragmentation</span> <span class="sqlScriptsNormal">&gt;=</span> <span class="sqlScriptsNormal">@rebuildThreshold</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@allowPageLocks</span> <span class="sqlScriptsNormal">&lt;&gt;</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@containsLOB</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsNormal">!=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@partitionCount</span> <span class="sqlScriptsNormal">&lt;=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Set online rebuild options; requires Enterprise Edition */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@onlineRebuild</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; Rebuild With (Online = On&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; Rebuild With (Online = Off&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Set sort operation preferences */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@sortInTempDB</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;, Sort_In_TempDB = On&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;, Sort_In_TempDB = Off&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Set processor restriction options; requires Enterprise Edition */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsOperator">Is</span> <span class="sqlScriptsOperator">Not</span> <span class="sqlScriptsOperator">Null</span> <span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">@editionCheck</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;, MaxDop = &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@maxDopRestriction</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">2</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;)&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@rebuildCommand</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;)&#39;</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@sqlCommand</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;Alter Index &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@indexName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39; On &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@databaseName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;.&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@schemaName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">N</span><span class="sqlScriptsString">&#39;.&#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@objectName</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@rebuildCommand</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Print an error message if any indexes happen to not meet the criteria above */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@printCommands</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;We are unable to defrag this index.&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Are we executing the SQL? &nbsp;If so, do it */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@executeSQL</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@debugMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsString">&#39;Executing: &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsNormal">@sqlCommand</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Print the commands we&#39;re executing if specified to do so */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@printCommands</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@debugMessage</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Grab the time for logging purposes */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@dateTimeStart</span> &nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">();</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Log our actions */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Insert</span> <span class="sqlScriptsKeyword">Into</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragLog</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">(</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">databaseName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">partitionNumber</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">fragmentation</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">page_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">dateTimeStart</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">sqlStatement</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">@databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@databaseName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@objectName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@indexName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@partitionNumber</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@fragmentation</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@pageCount</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@dateTimeStart</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@sqlCommand</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@indexDefrag_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">Scope_Identity</span><span class="sqlScriptsNormal">();</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Wrap our execution attempt in a try/catch and log any errors that occur */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span> <span class="sqlScriptsNormal">Try</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Execute our defrag! */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Execute</span> <span class="sqlScriptsStoredProcedure">sp_executesql</span> <span class="sqlScriptsNormal">@sqlCommand</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@dateTimeEnd</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">();</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Update our log with our completion time */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragLog</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">dateTimeEnd</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@dateTimeEnd</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">durationSeconds</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">DateDiff</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">second</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@dateTimeStart</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">@dateTimeEnd</span><span class="sqlScriptsOperator">)</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">indexDefrag_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexDefrag_id</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsNormal">Try</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span> <span class="sqlScriptsNormal">Catch</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Update our log with our error message */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragLog</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">dateTimeEnd</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">()</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">durationSeconds</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsOperator">-</span><span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">errorMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">Error_Message</span><span class="sqlScriptsNormal">()</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">indexDefrag_id</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexDefrag_id</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;An error has occurred executing this command! Please review the dba_indexDefragLog table for details.&#39;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsNormal">Catch</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Just a little breather for the server */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">WaitFor</span> <span class="sqlScriptsNormal">Delay</span> <span class="sqlScriptsNormal">@defragDelay</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">GetDate</span><span class="sqlScriptsNormal">()</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">printStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">databaseID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">objectID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">indexID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">partitionNumber</span> &nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@partitionNumber</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Else</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Looks like we&#39;re not executing, just printing the commands */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Printing SQL statements...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@printCommands</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsOperator">Or</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Print</span> <span class="sqlScriptsFunction">IsNull</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">@sqlCommand</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsString">&#39;error!&#39;</span><span class="sqlScriptsNormal">);</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Update</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">printStatus</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">databaseID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">objectID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">indexID</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsOperator">And</span> <span class="sqlScriptsNormal">partitionNumber</span> &nbsp;<span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">@partitionNumber</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* Do we want to output our fragmentation results? */</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@printFragmentation</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39; &nbsp;Displaying a summary of our action...&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Select</span> <span class="sqlScriptsNormal">databaseID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">databaseName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">objectName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexID</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">indexName</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">partitionNumber</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">fragmentation</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">page_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">range_scan_count</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">From</span> <span class="sqlScriptsNormal">dbo.dba_indexDefragStatus</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Where</span> <span class="sqlScriptsNormal">defragDate</span> <span class="sqlScriptsNormal">&gt;=</span> <span class="sqlScriptsNormal">@startDateTime</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Order</span> <span class="sqlScriptsKeyword">By</span> <span class="sqlScriptsNormal">defragDate</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsNormal">Try</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Begin</span> <span class="sqlScriptsNormal">Catch</span><br><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsNormal">@debugMessage</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsFunction">Error_Message</span><span class="sqlScriptsNormal">()</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39; (Line Number: &#39;</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsFunction">Cast</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsFunction">Error_Line</span><span class="sqlScriptsNormal">()</span> <span class="sqlScriptsKeyword">As</span> <span class="sqlScriptsKeyword">varchar</span><span class="sqlScriptsOperator">(</span><span class="sqlScriptsNormal">10</span><span class="sqlScriptsNormal">))</span> <span class="sqlScriptsOperator">+</span> <span class="sqlScriptsString">&#39;)&#39;</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Print</span> <span class="sqlScriptsNormal">@debugMessage</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">End</span> <span class="sqlScriptsNormal">Catch</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsComment">/* When everything is said and done, make sure to get rid of our temp table */</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Drop</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">databaseList</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Drop</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">processor</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Drop</span> <span class="sqlScriptsKeyword">Table</span> <span class="sqlScriptsNormal">#</span><span class="sqlScriptsNormal">maxPartitionList</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">If</span> <span class="sqlScriptsNormal">@debugMode</span> <span class="sqlScriptsOperator">=</span> <span class="sqlScriptsNormal">1</span> <span class="sqlScriptsKeyword">RaisError</span><span class="sqlScriptsNormal">(</span><span class="sqlScriptsString">&#39;DONE! &nbsp;Thank you for taking care of your indexes! &nbsp;:)&#39;</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">0</span><span class="sqlScriptsNormal">,</span> <span class="sqlScriptsNormal">42</span><span class="sqlScriptsOperator">)</span> <span class="sqlScriptsKeyword">With</span> <span class="sqlScriptsKeyword">NoWait</span><span class="sqlScriptsNormal">;</span><br><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Set</span> <span class="sqlScriptsKeyword">NoCount</span> <span class="sqlScriptsKeyword">Off</span><span class="sqlScriptsNormal">;</span><br> &nbsp;&nbsp;&nbsp;<span class="sqlScriptsKeyword">Return</span> <span class="sqlScriptsNormal">0</span><br><span class="sqlScriptsKeyword">End</span><br><span class="sqlScriptsNormal">GO</span><br></div></div></div><div class="panel panel-default panel-collapsible"><div class="panel-heading"><div class="expandCollapse"><img src="../../../../../Images/collapsed.png" alt="collapsed" title="collapsed" class="collapsed" style="display:none;"><img src="../../../../../Images/expanded.png" alt="expanded" title="expanded" class="expanded" style=""></div><a name="usedby">Used By</a></div><div class="panel-body"><ul class="DependencyList"><li><a href="../../../../../RaMP/User_databases/2.6.1/Programmability/Stored_Procedures/DefragIndexes.html">[dbo].[DefragIndexes]</a></li> </ul></div></div></div></div><div id="footer"><div class="row"><div id="customtext" class="col-sm-4"><div id="projectauthor">Author: &nbsp;No Limits Software</div></div><div id="copyright" class="col-sm-4">Copyright 2014 - All Rights Reserved</div><div id="date" class="col-sm-4">Created: 07 February 2014</div></div></div></body></html>